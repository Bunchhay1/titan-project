version: '3.8'

services:
  # ==========================================
  # ğŸ—„ï¸ DATABASE (PostgreSQL)
  # ==========================================
  titan-db:
    image: postgres:15-alpine
    container_name: titan-db-local
    environment:
      - POSTGRES_USER=postgres
      # âœ… FIX: áŠá¼ášá˜á€ password á±áŸ’á™áŠá¼á… Java
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=titandb
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    # âœ… OPTIONAL: áŠá¶á€áŸ‹ Volume áŠá¾á˜áŸ’á”á¸á€á»áŸ†á±áŸ’á™á”á¶ááŸ‹á‘á·á“áŸ’á“á“áŸá™á–áŸá› Restart
    # volumes:
    #   - titan_db_data:/var/lib/postgresql/data

  # ==========================================
  # âš¡ CACHE (Redis)
  # ==========================================
  titan-cache:
    image: redis:alpine
    container_name: titan-cache-local
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ==========================================
  # â˜• TITAN CORE (Java) -> Calls Mac for AI
  # ==========================================
  titan-core:
    build: 
      context: ./titan-core-banking
      dockerfile: Dockerfile
    container_name: titan-core-local
    ports:
      - "8080:8080"
    environment:
      # ğŸ‘‡ Connects to 'titan-db-local' (Container Name)
      - SPRING_DATASOURCE_URL=jdbc:postgresql://titan-db-local:5432/titandb
      - SPRING_DATASOURCE_USERNAME=postgres
      # âœ… FIX: ááŸ’ášá¼áœá‚áŸ’á“á¶á‡á¶á˜á½á™ DB áá¶á„á›á¾á á¾á™
      - SPRING_DATASOURCE_PASSWORD=password
      
      # ğŸ‘‡ Connects to 'titan-cache-local' (Container Name)
      - SPRING_DATA_REDIS_HOST=titan-cache-local
      - SPRING_DATA_REDIS_PORT=6379
      
      # ğŸ‘‡ Hybrid Mode (Calls Host Python)
      - GRPC_CLIENT_RISKENGINECLIENT_ADDRESS=static://host.docker.internal:50051
      - GRPC_CLIENT_RISKENGINECLIENT_NEGOTIATIONTYPE=PLAINTEXT
      - AI_HOST=host.docker.internal
      - AI_PORT=50051

    depends_on:
      titan-db:
        condition: service_healthy
      titan-cache:
        condition: service_healthy
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: on-failure

  # ==========================================
  # ğŸ¹ TITAN GATEWAY (Golang) -> Calls Java Core
  # ==========================================
  titan-gateway:
    build: 
      context: ./titan-gateway
      dockerfile: Dockerfile
    container_name: titan-gateway-local
    ports:
      - "3000:8000"
    environment:
      - PORT=8000
      
      # ğŸ‘‡ Connects to 'titan-core-local' (Container Name)
      - TARGET_CORE_URL=http://titan-core-local:8080
      
      # ğŸ‘‡ Connects to Mac for AI (Direct)
      - AI_SERVICE_URL=http://host.docker.internal:50051
      
    depends_on:
      - titan-core
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: on-failure

# ==========================================
# ğŸŒ NETWORK DEFINITION
# ==========================================
networks:
  default:
    name: titan-network
    driver: bridge

# volumes:
#   titan_db_data:
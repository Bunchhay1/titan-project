import requests
import random
import string
import json
import time
import sys

# ==============================================================================
# âš™ï¸ CONFIGURATION (UPDATED FOR LOCALHOST)
# ==============================================================================
# âœ… á™á¾á„á”áŸ’áá¼ášá‘áŸ… localhost á–áŸ’ášáŸ„áŸ‡ Docker á€áŸ†á–á»á„ášááŸ‹á›á¾á˜áŸ‰á¶áŸáŸŠá¸á“ášá”áŸáŸ‹á¢áŸ’á“á€
BASE_URL = "rabbit-das-trusted-trading.trycloudflareapi/v1" # Gateway Port

HEADERS = {"Content-Type": "application/json"}

class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    RESET = '\033[0m'

# ==============================================================================
# ğŸ› ï¸ HELPER FUNCTIONS
# ==============================================================================
def random_string(length=8):
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))

def print_status(method, endpoint, status, time_taken):
    color = Colors.GREEN if 200 <= status < 300 else Colors.RED
    print(f"{Colors.BLUE}[{method}]{Colors.RESET} {endpoint} -> {color}{status}{Colors.RESET} ({time_taken:.2f}s)")

# ==============================================================================
# ğŸš€ CORE TEST LOGIC
# ==============================================================================
def run_test_cycle():
    # 1. GENERATE USER DATA
    username = f"user_{random_string(5)}"
    email = f"{username}@titan.com"
    password = "password123"
    
    print(f"\n{Colors.YELLOW}--- ğŸ STARTING TEST CYCLE FOR: {username} ---{Colors.RESET}")

    # ---------------------------------------------------------
    # STEP 1: REGISTER (á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸)
    # ---------------------------------------------------------
    register_url = f"{BASE_URL}/auth/register"
    register_data = {
        "firstname": "Titan",
        "lastname": "Tester",
        "email": email,
        "password": password
    }
    
    try:
        start = time.time()
        res = requests.post(register_url, json=register_data, headers=HEADERS)
        duration = time.time() - start
        print_status("POST", "/auth/register", res.status_code, duration)

        if res.status_code != 200 and res.status_code != 201:
            print(f"{Colors.RED}âŒ Register Failed: {res.text}{Colors.RESET}")
            return
    except Exception as e:
        print(f"{Colors.RED}âŒ Error connecting to Gateway: {e}{Colors.RESET}")
        return

    # ---------------------------------------------------------
    # STEP 2: LOGIN (á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹áŠá¾á˜áŸ’á”á¸á™á€ Token)
    # ---------------------------------------------------------
    login_url = f"{BASE_URL}/auth/authenticate" # á¬ /auth/login á¢á¶áŸáŸ’ášáŸá™á›á¾ Code Java
    login_data = {
        "email": email,
        "password": password
    }

    token = None
    try:
        start = time.time()
        res = requests.post(login_url, json=login_data, headers=HEADERS)
        duration = time.time() - start
        print_status("POST", "/auth/authenticate", res.status_code, duration)

        if res.status_code == 200:
            data = res.json()
            # áŸáŸ’áœáŸ‚á„ášá€ Token á€áŸ’á“á»á„ Response (áˆáŸ’á˜áŸ„áŸ‡á¢á¶á…á‡á¶ access_token á¬ token)
            token = data.get("access_token") or data.get("token")
            print(f"{Colors.GREEN}âœ… Login Success! Token acquired.{Colors.RESET}")
        else:
            print(f"{Colors.RED}âŒ Login Failed: {res.text}{Colors.RESET}")
            return
    except Exception as e:
        print(f"Error: {e}")
        return

    # ---------------------------------------------------------
    # STEP 3: PROTECTED REQUEST (á”áŸ’ášá¾ Token áŠá¾á˜áŸ’á”á¸á áŸ… API)
    # ---------------------------------------------------------
    if token:
        # á”á„áŸ’á€á¾á Header ááŸ’á˜á¸áŠáŸ‚á›á˜á¶á“ Token
        auth_headers = HEADERS.copy()
        auth_headers["Authorization"] = f"Bearer {token}"

        # áŸá¶á€á›áŸ’á”á„á”á„áŸ’á€á¾áá‚áá“á¸á’á“á¶á‚á¶áš (Create Bank Account)
        create_acc_url = f"{BASE_URL}/accounts"
        acc_data = {
            "accountType": "SAVINGS",
            "initialDeposit": random.randint(100, 5000)
        }

        start = time.time()
        res = requests.post(create_acc_url, json=acc_data, headers=auth_headers)
        duration = time.time() - start
        print_status("POST", "/accounts", res.status_code, duration)

        if res.status_code in [200, 201]:
             print(f"{Colors.CYAN}ğŸ‰ Account Created Successfully!{Colors.RESET}")
        else:
             print(f"{Colors.RED}âŒ Failed to create account: {res.text}{Colors.RESET}")

# ==============================================================================
# ğŸ”„ MAIN EXECUTION
# ==============================================================================
if __name__ == "__main__":
    print(f"{Colors.CYAN}ğŸš€ TITAN SYSTEM TESTER LAUNCHED{Colors.RESET}")
    print(f"Target: {BASE_URL}\n")
    
    # áŸá½ášáá¶áá¾á…á„áŸ‹ Run á”áŸ‰á»á“áŸ’á˜á¶á“áŠá„?
    try:
        count = int(input("How many users do you want to simulate? (Default 1): ") or 1)
    except:
        count = 1

    for i in range(count):
        run_test_cycle()
        time.sleep(1) # áŸá˜áŸ’ášá¶á€ 1 áœá·á“á¶á‘á¸ášáœá¶á„ User á˜áŸ’á“á¶á€áŸ‹áŸ—